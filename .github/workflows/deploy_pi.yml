name: Build & Deploy to Raspberry Pi

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1️⃣ Checkout repository via SSH (geen HTTPS)
    - name: Checkout repository via SSH
      uses: actions/checkout@v4
      with:
        ssh-key: ${{ secrets.PI_SSH_KEY }}

    # 2️⃣ Build Docker image (let op: lowercase dockerfile)
    - name: Build Docker image
      run: |
        docker build -f dockerfile -t pi-builder .

    # 3️⃣ Compileer main.c in Pi-compatibele container
    - name: Compile application
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/src \
          pi-builder \
          gcc /src/main.c -o /src/led_test \
          -lpigpio -lrt -lpthread

    # 4️⃣ SSH setup voor Raspberry Pi
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.PI_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.PI_HOST }} >> ~/.ssh/known_hosts

    # 5️⃣ Stop lopende applicatie op Pi (indien aanwezig)
    - name: Stop running app on Pi
      run: |
        ssh ${{ secrets.PI_USER }}@${{ secrets.PI_HOST }} \
        "tmux kill-session -t led_app || true"

    # 6️⃣ Kopieer nieuwe executable naar Pi
    - name: Copy executable to Pi
      run: |
        scp led_test \
        ${{ secrets.PI_USER }}@${{ secrets.PI_HOST }}:${{ secrets.PI_APP_DIR }}/led_test

    # 7️⃣ Start applicatie opnieuw in tmux
    - name: Start app in tmux
      run: |
        ssh ${{ secrets.PI_USER }}@${{ secrets.PI_HOST }} \
        "tmux new-session -d -s led_app '${{ secrets.PI_APP_DIR }}/led_test'"
